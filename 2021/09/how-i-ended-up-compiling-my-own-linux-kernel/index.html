<!doctype html><html lang=en-us data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>How I ended up compiling my own Linux kernel - manueljimenezs</title><meta name=description content="I didn&rsquo;t expect this day would arrive. It&rsquo;s all fun and games until you buy a cheap graphic card with only a DVI port in it. It works great for FullHD resolutions. The problem is when you have resolutions and framerates bigger than that.
In the Linux kernel, the maximum pixel clock (the speed at which pixels are transmitted over a port) is limited to 165 MHz leading to messing with the images when displaying bigger resolutions than fullHD."><link rel=icon type=image/x-icon href=favicon.ico><link rel=apple-touch-icon-precomposed href=favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><link rel=stylesheet href=/css/style.min.0b964cc5cfe9ae8b741482fda65fc475aa83d02b3d6aff4335e95f752a8df29f.css integrity="sha256-C5ZMxc/prot0FIL9pl/EdaqD0Cs9av9DNelfdSqN8p8="><script src=/js/script.min.a65afe903825231554d9b55b073eb144da4ccf2d2823b216dcbc6cc656c9de76.js type=text/javascript integrity="sha256-plr+kDglIxVU2bVbBz6xRNpMzy0oI7IW3LxsxlbJ3nY="></script><meta property="og:title" content="How I ended up compiling my own Linux kernel"><meta property="og:description" content="I didn&rsquo;t expect this day would arrive. It&rsquo;s all fun and games until you buy a cheap graphic card with only a DVI port in it. It works great for FullHD resolutions. The problem is when you have resolutions and framerates bigger than that.
In the Linux kernel, the maximum pixel clock (the speed at which pixels are transmitted over a port) is limited to 165 MHz leading to messing with the images when displaying bigger resolutions than fullHD."><meta property="og:type" content="article"><meta property="og:url" content="/2021/09/how-i-ended-up-compiling-my-own-linux-kernel/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-20T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-20T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How I ended up compiling my own Linux kernel"><meta name=twitter:description content="I didn&rsquo;t expect this day would arrive. It&rsquo;s all fun and games until you buy a cheap graphic card with only a DVI port in it. It works great for FullHD resolutions. The problem is when you have resolutions and framerates bigger than that.
In the Linux kernel, the maximum pixel clock (the speed at which pixels are transmitted over a port) is limited to 165 MHz leading to messing with the images when displaying bigger resolutions than fullHD."></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><span class=site-logo><a href=/><svg height="24" viewBox="0 0 655 389" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2"><g id="layer1" transform="matrix(1,0,0,1,730.269,231.964)"><path id="path890" d="M-531.765-231.962C-532.739-231.955-533.717-231.932-534.694-231.89V-231.888C-564.056-230.636-590.585-214.002-604.5-188.117-618.414-162.231-617.657-130.927-602.504-105.745l32.078 55.058C-570.476-50.698-570.517-50.717-570.566-50.728c15.383 34.082-12.39 57.859-41.326 48.316C-622.593-7.084-635.12-10.49-647.416-10.525-693.175-10.525-730.269 26.572-730.269 72.332c0 45.76 37.0940000000001 82.857 82.853 82.858C-607.774 155.179-573.695 127.087-566.115 88.176c7-37.986 56.139-38.436 68.289-14.037L-497.713 74.109l22.422 38.486c22.838 40.422 74.318 54.365 114.433 30.992 40.114-23.372 53.372-75.035 29.469-114.836l-32.857-56.396C-374.139-55.314-339.589-67.769-326.721-50.702l95.268 165.01c22.65 40.566 74.114 54.753 114.351 31.524 40.238-23.229 53.686-74.891 29.883-114.791L-214.438-189.301c-15.28-27.351-44.617-43.811-75.924-42.6C-323.078-230.588-350.056-209.372-364.246-179.864-373.238-161.166-390.741-155.566-408.834-155.553-425.341-155.561-440.693-163.221-450.645-175.934L-458.602-189.59c-14.908-26.437-42.966-42.601-73.162-42.371L-531.765-231.962z" style="fill-rule:nonzero"/></g></svg></a></span><ul class=social-icons></ul><nav><input type=checkbox id=nav-trigger class=nav-trigger>
<label for=nav-trigger><span class=menu-icon><svg viewBox="0 0 18 15" width="18" height="15"><path d="M18 1.484c0 .82-.665 1.484-1.484 1.484H1.484C.665 2.969.0 2.304.0 1.484.0.665.665.0 1.484.0h15.032C17.335.0 18 .665 18 1.484zm0 6.032C18 8.335 17.335 9 16.516 9H1.484C.665 9 0 8.335.0 7.516c0-.82.665-1.484 1.484-1.484h15.032C17.335 6.031 18 6.696 18 7.516zm0 6C18 14.335 17.335 15 16.516 15H1.484C.665 15 0 14.335.0 13.516c0-.82.665-1.483 1.484-1.483h15.032C17.335 12.031 18 12.695 18 13.516z"/></svg></span></label><div class=trigger><a href=/tags/ title>Tags</a>
<a href=/archive/ title>Archive</a></div></nav></div></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">How I ended up compiling my own Linux kernel</h1></header></div><div class="content e-content"><p>I didn&rsquo;t expect this day would arrive. It&rsquo;s all fun and games until you buy a cheap graphic card with only a DVI port in it. It works great for FullHD resolutions. The problem is when you have resolutions and framerates bigger than that.</p><p>In the Linux kernel, the maximum pixel clock (the speed at which pixels are transmitted over a port) is limited to 165 MHz leading to messing with the images when displaying bigger resolutions than fullHD.</p><p>There are two solutions to this problem:</p><ul><li><p>Using lower resolutions/framerates, this means not taking advantage of e.g ultrawide monitors. (Spoiler: nobody wants this ðŸ˜›)</p></li><li><p>Tweaking your kernel, increasing the clock ratio and happily use your shiny screen as it was intended.</p></li></ul><h2 id=getting-your-hands-dirty>Getting your hands dirty
<span><a href=#getting-your-hands-dirty><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>After a long journey searching on the interwebs, I found that increasing the pixel clock to 250 MHz is enough for WFHD resolutions. There is even a <a href=https://www.monitortests.com/pixelclock.php>calculator</a> for that.</p><p><strong>Note that you may be running your graphics card out of spec, and you can irreversibly damage your hardware so be very cautious with this.</strong></p><p>Here is the line in the Linux kernel that we&rsquo;re going to change. This change is provide as a patch file, which concisely represents how and where a change in a file is made. Something like <code>diff --git oldfile.txt newfile.txt</code> will suffice.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>--- a/drivers/gpu/drm/amd/display/include/signal_types.h	2020-12-17 20:11:00.261706513 +0100
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/drivers/gpu/drm/amd/display/include/signal_types.h	2020-12-17 20:09:14.391997315 +0100
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -29,7 +29,7 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> /* Minimum pixel clock, in KHz. For TMDS signal is 25.00 MHz */
</span></span><span style=display:flex><span> #define TMDS_MIN_PIXEL_CLOCK 25000
</span></span><span style=display:flex><span> /* Maximum pixel clock, in KHz. For TMDS signal is 165.00 MHz */
</span></span><span style=display:flex><span><span style=color:#f92672>-#define TMDS_MAX_PIXEL_CLOCK 165000
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+#define TMDS_MAX_PIXEL_CLOCK 250000
</span></span></span></code></pre></div><p>I also created a script that downloads the linux source code, automatically applies all the patches and compiles it with a basic config. <a href=https://github.com/manueljimenezs/linux-build-script>Here</a> is the full set of files.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>KERNELVER<span style=color:#f92672>=</span>linux-5.14.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>get_and_prepare<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    wget https://cdn.kernel.org/pub/linux/kernel/v5.x/$KERNELVER.tar.xz
</span></span><span style=display:flex><span>    tar -xf $KERNELVER.tar.xz
</span></span><span style=display:flex><span>    cp -r config $KERNELVER/.config
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>patch_kernel<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>	
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> i in <span style=color:#66d9ef>$(</span>ls patches<span style=color:#66d9ef>)</span>; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>     patch -Np1 -d $KERNELVER &lt; patches/0001-amdgpu-clock.patch
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>build<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    export KBUILD_BUILD_HOST<span style=color:#f92672>=</span>archlinux
</span></span><span style=display:flex><span>    export KBUILD_BUILD_USER<span style=color:#f92672>=</span>linux-amdclock
</span></span><span style=display:flex><span>    cd $KERNELVER
</span></span><span style=display:flex><span>    make -j10
</span></span><span style=display:flex><span>    make modules -j10
</span></span><span style=display:flex><span>    sudo cp -v arch/x86/boot/bzImage /boot/vmlinuz-linux-amdclock
</span></span><span style=display:flex><span>    sudo make modules_install
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ! command -v wget &amp;&gt; /dev/null; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    echo <span style=color:#e6db74>&#34;Please install wget&#34;</span>
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> in
</span></span><span style=display:flex><span> -b|--build-only<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    build
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    ;;
</span></span><span style=display:flex><span> -p|--patch-only<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    patch_kernel
</span></span><span style=display:flex><span>    exit <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    ;;
</span></span><span style=display:flex><span><span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>get_and_prepare
</span></span><span style=display:flex><span>patch_kernel
</span></span><span style=display:flex><span>build
</span></span></code></pre></div><p>On each update you would have to increase the kernel version and recompile the new kernel to copy it to your bootdir.</p><p>Also, you would have to blacklist the <code>linux</code> package on your distribution&rsquo;s package manager so it doesn&rsquo;t automatically update and you don&rsquo;t lose the changes made.</p><p>In the case of Archlinux, as aaalwayss ;)) the wiki clearly explains it: <a href=https://wiki.archlinux.org/title/Pacman#Skip_package_from_being_upgraded>link</a></p></div><div class=post-info><div class="post-date dt-published">Sep 20, 2021</div><a class="post-hidden-url u-url" href=/2021/09/how-i-ended-up-compiling-my-own-linux-kernel/>/2021/09/how-i-ended-up-compiling-my-own-linux-kernel/</a>
<a href class="p-name p-author post-hidden-author h-card" rel=me>Manu</a><div class=post-taxonomies><ul class=post-tags><li><a href=/tags/archlinux/>#archlinux</a></li><li><a href=/tags/kernel/>#kernel</a></li><li><a href=/tags/tools/>#tools</a></li></ul></div></div></article><div class="pagination post-pagination"><div class="left pagination-item"><a href=/2021/12/hidden-post/>Hidden Post</a></div><div class="right pagination-item"><a href=/2020/05/full-disk-encryption-on-archlinux-with-lvm-luks-btrfs/>Full-disk encryption on Archlinux with LVM+LUKS+BTRFS</a></div></div></main><footer class=common-footer><div class=common-footer-bottom><div class=copyright><p>Â© Manu, 2022<br>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/mitrichius/hugo-theme-anubis>Anubis</a>.<br></p></div><script>const STORAGE_KEY="user-color-scheme",defaultTheme="auto-without-switcher";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),switchButton&&(changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)),showContent()});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(e){e&&(e.textContent=currentTheme=="dark"?"Light theme":"Dark theme")}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}</script></div><p class="h-card vcard"><a href='class="p-name' u-url url fn" rel=me>Manu</a></p></footer></div></body></html>